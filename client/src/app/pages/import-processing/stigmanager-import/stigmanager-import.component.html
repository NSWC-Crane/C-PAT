<!--
!##########################################################################
! CRANE PLAN OF ACTION AND MILESTONE AUTOMATION TOOL (C-PAT) SOFTWARE
! Use is governed by the Open Source Academic Research License Agreement
! contained in the LICENSE.MD file, which is part of this software package.
! BY USING OR MODIFYING THIS SOFTWARE, YOU ARE AGREEING TO THE TERMS AND
! CONDITIONS OF THE LICENSE.
!##########################################################################
-->

<p-card>
  <p-tabs value="0">
    <p-tablist>
      <p-tab value="0">
        <span *ngIf="viewMode === 'summary'">STIG Manager Benchmarks</span>
        <span *ngIf="viewMode === 'findings'">STIG Manager Findings ({{ findingsCount }})</span>
      </p-tab>
      <p-tab value="1">STIG Manager Reviews</p-tab>
    </p-tablist>
    <p-tabpanels>
      <p-tabpanel value="0">
        <div *ngIf="viewMode === 'summary'" class="benchmark-summary">
          <p-table [value]="loadingTableInfo ? loadingSkeletonData : benchmarkSummaries"
                   selectionMode="single"
                   [paginator]="true"
                   [rows]="25"
                   [scrollable]="true"
                   scrollHeight="calc(100vh - 25rem)"
                   [rowsPerPageOptions]="[10, 25, 50]"
                   dataKey="benchmarkId">
            <ng-template pTemplate="header">
              <tr>
                <th pSortableColumn="benchmarkId">Benchmark</th>
                <th pSortableColumn="revisionStr">Revision</th>
                <th pSortableColumn="assets">Assets</th>
                <th pSortableColumn="metrics.assessments">Checks</th>
                <th pSortableColumn="metrics.minTs">Oldest</th>
                <th pSortableColumn="metrics.maxTs">Newest</th>
                <th pSortableColumn="metrics.maxTouchTs">Updated</th>
                <th>Assessed</th>
                <th>Submitted</th>
                <th>Accepted</th>
                <th>Rejected</th>
                <th>CAT 3</th>
                <th>CAT 2</th>
                <th>CAT 1</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-benchmark>
              <tr (click)="selectBenchmark(benchmark)" [style.cursor]="'pointer'">
                <td>{{benchmark.benchmarkId}}</td>
                <td>{{benchmark.revisionStr}}</td>
                <td>{{benchmark.assets}}</td>
                <td>{{benchmark.metrics?.assessments || 0}}</td>
                <td>{{benchmark.metrics?.minTs ? (benchmark.metrics.minTs | date:'shortDate') : '-'}}</td>
                <td>{{benchmark.metrics?.maxTs ? (benchmark.metrics.maxTs | date:'shortDate') : '-'}}</td>
                <td>{{benchmark.metrics?.maxTouchTs ? (benchmark.metrics.maxTouchTs | date:'shortDate') : '-'}}</td>
                <td>
                  <p-progressBar [value]="(benchmark.metrics?.assessed / benchmark.metrics?.assessments) * 100 || 0"
                                 [style]="{'height': '20px'}"
                                 styleClass="assessed-progress">
                    <ng-template pTemplate="content" let-value>
                      {{(value || 0) | number:'1.0-0'}}%
                    </ng-template>
                  </p-progressBar>
                </td>
                <td>
                  <p-progressBar [value]="(benchmark.metrics?.statuses?.submitted / benchmark.metrics?.assessments) * 100 || 0"
                                 [style]="{'height': '20px'}"
                                 styleClass="submitted-progress">
                    <ng-template pTemplate="content" let-value>
                      {{(value || 0) | number:'1.0-0'}}%
                    </ng-template>
                  </p-progressBar>
                </td>
                <td>
                  <p-progressBar [value]="(benchmark.metrics?.statuses?.accepted / benchmark.metrics?.assessments) * 100 || 0"
                                 [style]="{'height': '20px'}"
                                 styleClass="accepted-progress">
                    <ng-template pTemplate="content" let-value>
                      {{(value || 0) | number:'1.0-0'}}%
                    </ng-template>
                  </p-progressBar>
                </td>
                <td>
                  <p-progressBar [value]="(benchmark.metrics?.statuses?.rejected / benchmark.metrics?.assessments) * 100 || 0"
                                 [style]="{'height': '20px'}"
                                 styleClass="rejected-progress">
                    <ng-template pTemplate="content" let-value>
                      {{(value || 0) | number:'1.0-0'}}%
                    </ng-template>
                  </p-progressBar>
                </td>
                <td>{{benchmark.metrics?.findings?.low || 0}}</td>
                <td>{{benchmark.metrics?.findings?.medium || 0}}</td>
                <td>{{benchmark.metrics?.findings?.high || 0}}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
        <div *ngIf="viewMode === 'findings'">
          <div class="toolbar mb-4 mt-4">
            <div class="flex items-center justify-between">
              <p-iconField iconPosition="left">
                <p-inputIcon>
                  <i class="pi pi-search"></i>
                </p-inputIcon>
                <input pInputText
                       type="text"
                       class="w-48"
                       (input)="filterGlobal($event)"
                       placeholder="Search..." />
              </p-iconField>
              <p-button [rounded]="true"
                        [text]="true"
                        [raised]="true"
                        severity="secondary"
                        class="ml-4"
                        icon="pi pi-filter-slash"
                        (click)="clear()"
                        pTooltip="Clear all filters">
              </p-button>
              <p-button [rounded]="true"
                        [text]="true"
                        [raised]="true"
                        class="ml-4"
                        icon="pi pi-arrow-left"
                        pTooltip="Back to Benchmarks"
                        (click)="backToBenchmarkSummary()">
              </p-button>
            </div>
            <div class="right-buttons">
              <p-button icon="pi pi-external-link"
                        severity="secondary"
                        [rounded]="true"
                        [text]="true"
                        (onClick)="exportCSV()">
              </p-button>
            </div>
          </div>

          <div class="table-container">
            <p-table #stigFindingsTable
                     [value]="loadingTableInfo ? loadingSkeletonData : displayDataSource"
                     selectionMode="single"
                     [columns]="allColumns"
                     [globalFilterFields]="['groupId', 'ruleTitle', 'severity']"
                     (onSort)="updateSort($event)"
                     (onFilter)="onFilter($event)"
                     [paginator]="true"
                     [rows]="25"
                     [scrollable]="true"
                     scrollHeight="calc(100vh - 25rem)"
                     [rowsPerPageOptions]="[10, 25, 50]"
                     dataKey="groupId">
              <ng-template pTemplate="header">
                <tr>
                  <th *ngFor="let col of allColumns"
                      id="col"
                      [pSortableColumn]="col.field"
                      [ngStyle]="{'width': col.width}">
                    {{col.header}}
                    <ng-container *ngIf="col.field === 'poam'">
                      <p-columnFilter [field]="col.filterField"
                                      type="multi"
                                      matchMode="in"
                                      [showOperator]="false"
                                      [showMatchModes]="false"
                                      [showAddButton]="false"
                                      [showButtons]="true"
                                      display="menu">
                        <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                          <p-multiSelect [ngModel]="value"
                                         [options]="col.filterOptions"
                                         (onChange)="filter($event.value)"
                                         placeholder="Select Status"
                                         [showClear]="true"
                                         styleClass="w-full">
                          </p-multiSelect>
                        </ng-template>
                      </p-columnFilter>
                    </ng-container>
                    <ng-container *ngIf="col.field === 'severity'">
                      <p-columnFilter type="multi"
                                      [field]="col.field"
                                      matchMode="in"
                                      [showOperator]="false"
                                      [showMatchModes]="false"
                                      [showAddButton]="false"
                                      [showButtons]="true"
                                      display="menu">
                        <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                          <p-multiSelect [ngModel]="value"
                                         [options]="col.filterOptions"
                                         (onChange)="filter($event.value)"
                                         placeholder="Select Severity"
                                         [showClear]="true"
                                         styleClass="w-full">
                          </p-multiSelect>
                        </ng-template>
                      </p-columnFilter>
                    </ng-container>
                    <p-columnFilter *ngIf="col.field !== 'poam' && col.field !== 'severity' && col.field !== 'benchmarkId'"
                                    [type]="col.filterType"
                                    [field]="col.field"
                                    [showOperator]="false"
                                    display="menu">
                    </p-columnFilter>
                  </th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-rowData>
                <tr>
                  <td *ngFor="let col of allColumns">
                    <ng-container *ngIf="loadingTableInfo; else loadedData">
                      <p-skeleton [style]="{height: '2rem'}"></p-skeleton>
                    </ng-container>
                    <ng-template #loadedData>
                      <ng-container [ngSwitch]="col.field">
                        <ng-container *ngSwitchCase="'poam'">
                          <i [class]="'pi ' + getPoamStatusIcon(rowData.hasExistingPoam)"
                             [ngStyle]="{ 'color': !rowData.hasExistingPoam ? 'maroon' : getPoamStatusColor(rowData.poamStatus), 'font-size': '1.5rem', 'cursor': 'pointer', 'justify-content': 'center' }"
                             (click)="addPoam(rowData)"
                             (keyup.enter)="addPoam(rowData)"
                             [pTooltip]="getPoamStatusTooltip(rowData.poamStatus, rowData.hasExistingPoam)"
                             tooltipPosition="top">
                          </i>
                        </ng-container>
                        <ng-container *ngSwitchCase="'severity'">
                          <p-tag [value]="rowData.severity"
                                 [severity]="getSeverityStyling(rowData.severity)"
                                 [rounded]="false">
                          </p-tag>
                        </ng-container>
                        <ng-container *ngSwitchDefault> {{rowData[col.field] || '-'}} </ng-container>
                      </ng-container>
                    </ng-template>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      </p-tabpanel>
      <p-tabpanel value="1" *ngIf="this.stigmanCollection?.collectionId">
        <cpat-stigmanager-reviews-table [stigmanCollectionId]="this.stigmanCollection?.collectionId"></cpat-stigmanager-reviews-table>
      </p-tabpanel>
    </p-tabpanels>
  </p-tabs>
</p-card>
<p-toast></p-toast>
