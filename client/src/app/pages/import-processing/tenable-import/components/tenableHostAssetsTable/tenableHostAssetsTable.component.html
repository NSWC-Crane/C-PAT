<!--
!##########################################################################
! CRANE PLAN OF ACTION AND MILESTONE AUTOMATION TOOL (C-PAT) SOFTWARE
! Use is governed by the Open Source Academic Research License Agreement
! contained in the LICENSE.MD file, which is part of this software package.
! BY USING OR MODIFYING THIS SOFTWARE, YOU ARE AGREEING TO THE TERMS AND
! CONDITIONS OF THE LICENSE.
!##########################################################################
-->

<div class="row col-span-12">
  <div class="col">
    <div class="p-fluid">
      <div class="toolbar mb-4">
        <div class="flex items-center justify-between">
          <p-iconField iconPosition="left">
            <p-inputIcon>
              <i class="pi pi-search"></i>
            </p-inputIcon>
            <input pInputText type="text" id="search" [(ngModel)]="filterValue" (input)="onGlobalFilter($event)" placeholder="Search..." />
          </p-iconField>
          <p-button [rounded]="true" [text]="true" [raised]="true" severity="secondary" class="ml-2" icon="pi pi-filter-slash" (click)="clear()" pTooltip="Clear all filters" />
        </div>
        <div class="right-buttons">
          <p-button class="mr-2" [rounded]="true" [text]="true" [raised]="true" severity="secondary" icon="pi pi-refresh" (click)="resetColumnSelections()" pTooltip="Reset column selections" />
          <p-button icon="pi pi-plus" [rounded]="true" [text]="true" [raised]="true" severity="primary" (click)="toggleAddColumnOverlay()" />
          <p-button icon="pi pi-external-link" severity="secondary" [rounded]="true" [text]="true" (onClick)="exportCSV()" />
          <p-multiSelect #ms [options]="cols" [(ngModel)]="selectedColumns" optionLabel="header" class="custom-multiselect" appendTo="body" name="columnSearch" filterPlaceHolder="Add columns..." [showToggleAll]="true" />
        </div>
      </div>
      <p-table
        #hostAssetTable
        [value]="affectedAssets"
        [columns]="selectedColumns"
        [paginator]="true"
        [rows]="25"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 25, 50]"
        [totalRecords]="totalRecords"
        [loading]="isLoading"
        [globalFilterFields]="['name', 'os', 'macAddress', 'firstSeen', 'lastSeen', 'netBios', 'dns', 'ipAddress', 'systemType', 'uuid', 'source', 'acr', 'acrLastEvaluatedTime', 'aes']"
        [filterDelay]="300"
        [rowHover]="true"
        dataKey="id"
        [resizableColumns]="true"
        [scrollable]="true"
        scrollHeight="calc(100vh - 27rem)"
        class="p-datatable-sm"
      >
        <ng-template pTemplate="header" let-columns>
          <tr>
            @for (col of columns; track col) {
              <th scope="col" [pSortableColumn]="col.field" pResizableColumn>
                {{ col.header }}
                <ng-container>
                  <p-columnFilter [type]="col.filterType" [field]="col.field" [showMatchModes]="true" [showOperator]="false" [showAddButton]="false" [showApplyButton]="true" [showClearButton]="true" [display]="'menu'" [showMenu]="true" />
                </ng-container>
              </th>
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-host let-columns="columns">
          <tr>
            @for (col of columns; track col) {
              <td>
                @switch (col.field) {
                  @case ('name') {
                    <span (click)="onHostNameClick(host, $event)" (keyup.enter)="onHostNameClick(host, $event)" style="cursor: pointer; color: var(--p-primary-color); font-weight: bold">
                      {{ host[col.field] }}
                    </span>
                  }
                  @case ('source') {
                    <p-tag [value]="host[col.field]" [rounded]="false" />
                  }
                  @default {
                    {{ host[col.field] }}
                  }
                }
              </td>
            }
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td [attr.colspan]="selectedColumns.length" style="text-align: center">No assets to display</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

@if (selectedHost) {
  <cpat-tenable-host-dialog [host]="selectedHost" [tenableRepoId]="tenableRepoId" [(visible)]="displayDialog" />
}

<p-toast position="center" key="error" />
