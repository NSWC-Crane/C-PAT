/*
!##########################################################################
! CRANE PLAN OF ACTION AND MILESTONE AUTOMATION TOOL (C-PAT) SOFTWARE
! Use is governed by the Open Source Academic Research License Agreement
! contained in the LICENSE.MD file, which is part of this software package.
! BY USING OR MODIFYING THIS SOFTWARE, YOU ARE AGREEING TO THE TERMS AND
! CONDITIONS OF THE LICENSE.
!##########################################################################
*/

import { IAVInfo, ParsedReferences, PoamAssociation, Reference, SeverityStyle, VprContextItem } from '../../../../common/models/tenable.model';

export function getSeverityStyling(severity: string): SeverityStyle {
  switch (severity) {
    case 'Critical':
    case 'High':
      return 'danger';
    case 'Medium':
      return 'warn';
    case 'Low':
    case 'Info':
      return 'info';
    default:
      return 'info';
  }
}

export function getPoamStatusColor(status: string, parentStatus?: string): string {
  const effectiveStatus = status === 'Associated' && parentStatus ? parentStatus : status;

  switch (effectiveStatus?.toLowerCase()) {
    case 'draft':
      return 'darkorange';
    case 'expired':
    case 'rejected':
      return 'firebrick';
    case 'submitted':
    case 'pending cat-i approval':
    case 'extension requested':
      return 'goldenrod';
    case 'false-positive':
    case 'closed':
      return 'black';
    case 'approved':
      return 'green';
    default:
      return 'gray';
  }
}

export function getPoamStatusIcon(status: string, isAssociated?: boolean): string {
  if (isAssociated) {
    return 'pi pi-info-circle';
  }

  switch (status?.toLowerCase()) {
    case 'no existing poam':
      return 'pi pi-plus-circle';
    case 'expired':
    case 'rejected':
      return 'pi pi-ban';
    case 'draft':
    case 'submitted':
    case 'pending cat-i approval':
    case 'extension requested':
    case 'false-positive':
    case 'closed':
    case 'approved':
      return 'pi pi-check-circle';
    default:
      return 'pi pi-question-circle';
  }
}

export function getPoamStatusTooltip(status: string | null, hasExistingPoam?: boolean, parentStatus?: string): string {
  if (!status || status === 'No Existing POAM') {
    return 'No Existing POAM. Click icon to create draft POAM.';
  }

  if (hasExistingPoam && status === 'Associated') {
    const parentStatusText = parentStatus ? ` (Parent POAM Status: ${parentStatus})` : '';

    return `This vulnerability is associated with an existing POAM${parentStatusText}. Click icon to view POAM.`;
  }

  return `POAM Status: ${status}. Click to view POAM.`;
}

export function parseReferences(xrefs: string): ParsedReferences {
  const refs = xrefs.split(/\s+/).filter(Boolean);
  const cveReferences: Reference[] = [];
  const iavReferences: Reference[] = [];
  const otherReferences: Reference[] = [];

  refs.forEach((ref: string) => {
    const [refType, ...valueParts] = ref.split(':');
    const value = valueParts.join(':').replace(/,\s*$/, '').trim();

    if (refType && value) {
      if (refType === 'CVE') {
        cveReferences.push({ type: refType, value });
      } else if (['IAVA', 'IAVB', 'IAVT'].includes(refType)) {
        iavReferences.push({ type: refType, value });
      } else {
        otherReferences.push({ type: refType, value });
      }
    } else {
      console.warn(`Invalid reference: ${ref}`);
    }
  });

  return { cveReferences, iavReferences, otherReferences };
}

export function parseVprContext(vprContext: string): VprContextItem[] {
  try {
    return JSON.parse(vprContext);
  } catch (error) {
    console.error('Error parsing VPR context:', error);

    return [];
  }
}

export function getCveUrl(cve: string): string {
  return `https://web.nvd.nist.gov/view/vuln/detail?vulnId=${cve}`;
}

export function getIavUrl(iavNumber: string): string {
  return `https://vram.navy.mil/standalone_pages/iav_display?notice_number=${iavNumber}`;
}

export function createIAVInfoMap(iavData: any[]): { [key: number]: IAVInfo } {
  return iavData.reduce((acc: { [key: number]: IAVInfo }, item: any) => {
    acc[item.pluginID] = {
      iav: item.iav || null,
      navyComplyDate: item.navyComplyDate ? item.navyComplyDate.split('T')[0] : null
    };

    return acc;
  }, {});
}

export function createPoamAssociationsMap(poamData: { vulnerabilityId: string; poamId: number; status: string; parentPoamId?: number; parentStatus?: string }[]): { [key: string]: PoamAssociation } {
  return poamData.reduce((acc: { [key: string]: PoamAssociation }, item) => {
    acc[item.vulnerabilityId] = {
      poamId: item.poamId,
      status: item.status,
      isAssociated: item.status === 'Associated',
      parentStatus: item.parentStatus,
      parentPoamId: item.parentPoamId
    };

    return acc;
  }, {});
}
