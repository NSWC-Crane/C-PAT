<!--
!##########################################################################
! CRANE PLAN OF ACTION AND MILESTONE AUTOMATION TOOL (C-PAT) SOFTWARE
! Use is governed by the Open Source Academic Research License Agreement
! contained in the LICENSE.MD file, which is part of this software package.
! BY USING OR MODIFYING THIS SOFTWARE, YOU ARE AGREEING TO THE TERMS AND
! CONDITIONS OF THE LICENSE.
!##########################################################################
-->

<div class="flex justify-between items-center card !p-2">
  <div class="font-medium opacity-70 ml-2">
    {{ collectionName() }} - {{ now | date: 'MMM d, y, h:mm a' }}
  </div>
  <div class="relative flex gap-1 mr-1">
    <p-button icon="pi pi-refresh" [rounded]="true" [text]="true" severity="secondary" (onClick)="refreshMetrics()"
      [disabled]="isLoading()" pTooltip="Refresh metrics" tooltipPosition="left" />
    <p-button icon="pi pi-external-link" severity="secondary" [rounded]="true" [text]="true" pTooltip="Export metrics"
      tooltipPosition="left" (onClick)="exportMetrics()" [disabled]="isLoading()" />
  </div>
</div>

<div class="flex flex-row mt-4 gap-4">
  <p-card class="basis-1/6">
    <div class="flex flex-col items-center justify-center p-2">
      <div class="flex flex-col items-center"
        [pTooltip]="'Percentage calculation: (Critical + High + Medium + Low findings (Last observed within 30 days) with approved POAMs) ÷ (Total findings lLast observed within 30 days) × 100'"
        tooltipPosition="top">
        <div class="rounded-3xl flex flex-col items-center justify-center shadow-xl border-[3px] p-8 gap-2"
          [style.border-color]="getCoraRiskColor(100 - tenableMetrics().totalPoamCompliance)"
          [style.color]="getCoraRiskColor(100 - tenableMetrics().totalPoamCompliance)">
          <div class="flex flex-row items-center">
            <span class="text-[4rem] font-extrabold leading-none pl-4">
              {{ isLoading() ? '-' : tenableMetrics().totalPoamCompliance.toFixed(0) }}
            </span>
            <span class="text-[1rem] font-bold">%</span>
          </div>
          <div class="mt-4 text-center font-semibold text-[var(--text-color)] opacity-80">POAM Compliance</div>
        </div>
      </div>
    </div>
  </p-card>

  <p-card class="basis-5/6">
    <div class="relative">
      <div class="relative mb-[-2rem] mr-2 ml-2" style="height: 60px;">
        <div class="absolute w-full">
          <div class="absolute" [style.left.%]="100 - tenableMetrics().coraRiskScore"
            style="transform: translateX(-50%); z-index: 10;">
            <div class="flex items-center gap-2 -mt-2 ml-2 mr-2">
              <div class="px-3 py-2 rounded-lg font-bold text-center"
                [style.background-color]="getCoraRiskColor(tenableMetrics().coraRiskScore)"
                style="opacity: 0.9; color: white;" pTooltip="Weighted Average formula:
      (CAT I Risk % × 10 + CAT II Risk % × 4 + CAT III Risk % × 1) ÷ 15

      Where CAT I = Critical + High, CAT II = Medium, CAT III = Low">
                {{ isLoading() ? '-' : tenableMetrics().coraRiskScore.toFixed(0) + '%' }}
              </div>
            </div>
            <div class="absolute left-1/2 transform -translate-x-1/2"
              style="width: 2px; background-color: white; height: 50px; top: 38px;">
              <div class="absolute w-2 h-2 bg-white rounded-full" style="top: -4px; left: -3px;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="relative">
        <div class="flex justify-between mb-2">
          <span class="text-red-400 font-semibold text-xs">High Risk</span>
          <span class="text-green-400 font-semibold text-xs text-right">Low Risk</span>
        </div>

        <div class="relative rounded-full h-10 overflow-hidden shadow-lg"
          style="background: linear-gradient(to right, rgba(236, 72, 99, 0.8) 0%, rgba(251, 146, 60, 0.8) 33%, rgba(251, 191, 36, 0.8) 66%, rgba(16, 185, 129, 0.8) 100%);">
        </div>
      </div>
    </div>

    <div class="mt-5 pt-3 border-t border-gray-700">
      <div class="flex justify-between gap-2">
        <div class="flex items-center gap-1">
          <div class="w-8 h-3 rounded-full" style="background-color: rgba(236, 72, 99, 0.8);"></div>
          <span class="text-xs text-gray-300">Very High</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-8 h-3 rounded-full" style="background-color: rgba(247, 128, 69, 0.8);"></div>
          <span class="text-xs text-gray-300">High</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-8 h-3 rounded-full" style="background-color: rgba(251, 167, 50, 0.8);"></div>
          <span class="text-xs text-gray-300">Moderate</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-8 h-3 rounded-full" style="background-color: rgba(230, 185, 44, 0.8);"></div>
          <span class="text-xs text-gray-300">Low</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-8 h-3 rounded-full" style="background-color: rgba(16, 185, 129, 0.8);"></div>
          <span class="text-xs text-gray-300">Very Low</span>
        </div>
      </div>
    </div>
  </p-card>
</div>

<div class="flex flex-row mt-4 gap-4">
  <div class="basis-1/3">
    <p-card class="cat-compliance-card">
      <div class="dark-web-style-metric">
        <div class="metric-circle-container">
          <div class="metric-circle">
            <span class="metric-circle-value">
              {{ isLoading() ? '-' : tenableMetrics().catICompliance.toFixed(0) }}
            </span>
            <span class="metric-percent">%</span>
          </div>
          <div class="metric-line"></div>
        </div>
        <div class="metric-text-container"
          pTooltip="Percentage of Critical and High severity findings that were published 30+ days ago, last observed within 30 days, and have an existing POAM in an Approved status."
          tooltipPosition="top">
          <div class="metric-origin">Tenable</div>
          <div class="metric-description pr-[7.5px]">CAT-I POAM Compliance %</div>
        </div>
      </div>
    </p-card>
  </div>

  <div class="basis-1/3">
    <p-card class="cat-compliance-card">
      <div class="dark-web-style-metric">
        <div class="metric-circle-container">
          <div class="metric-circle">
            <span class="metric-circle-value">
              {{ isLoading() ? '-' : tenableMetrics().catIICompliance.toFixed(0) }}
            </span>
            <span class="metric-percent">%</span>
          </div>
          <div class="metric-line"></div>
        </div>
        <div class="metric-text-container"
          pTooltip="Percentage of Medium severity findings that were published 30+ days ago, last observed within 30 days, and have an existing POAM in an Approved status."
          tooltipPosition="top">
          <div class="metric-origin">Tenable</div>
          <div class="metric-description pr-[3.75px]">CAT-II POAM Compliance %</div>
        </div>
      </div>
    </p-card>
  </div>

  <div class="basis-1/3">
    <p-card class="cat-compliance-card">
      <div class="dark-web-style-metric">
        <div class="metric-circle-container">
          <div class="metric-circle">
            <span class="metric-circle-value">
              {{ isLoading() ? '-' : tenableMetrics().catIIICompliance.toFixed(0) }}
            </span>
            <span class="metric-percent">%</span>
          </div>
          <div class="metric-line"></div>
        </div>
        <div class="metric-text-container"
          pTooltip="Percentage of Low severity findings that were published 30+ days ago, last observed within 30 days, and have an existing POAM in an Approved status."
          tooltipPosition="top">
          <div class="metric-origin">Tenable</div>
          <div class="metric-description">CAT-III POAM Compliance %</div>
        </div>
      </div>
    </p-card>
  </div>
</div>

<div class="card flex flex-row mt-4">
  <div class="basis-1/2">
    <div class="h-full flex flex-col">
      <h3 class="chart-title">Open Findings by Severity (30+ Days)</h3>

      @if (findingsChartData()) {
      <div class="flex items-center w-full flex-grow">
        <div class="flex-[0_0_55%] flex justify-center items-center">
          <p-chart type="doughnut" [data]="findingsChartData()" [options]="findingsChartOptions()"
            styleClass="findings-chart">
          </p-chart>
        </div>

        <div class="flex-[0_0_45%] flex flex-col justify-center ml-2">
          <div class="flex flex-col w-full gap-4">
            <div
              class="w-full flex items-center pr-2 transition-all duration-300 ease-in-out cursor-default hover:translate-x-2 legend-item">
              <div class="shrink-0 mr-2 w-5 h-5 rounded transition-all duration-300 ease-in-out item-color"
                [style.backgroundColor]="'rgba(236, 72, 99, 0.8)'"></div>
              <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-semibold ml-2 flex-1 item-label">
                Critical / High</div>
              <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-medium min-w-[1.5rem] item-value">{{
                tenableMetrics().catIOpenCount30Days }}</div>
              <div
                class="text-[var(--text-color)] opacity-70 text-[0.875rem] ml-2 w-14 text-left shrink-0 item-percent">
                {{ totalFindings30Days() > 0 ? ((tenableMetrics().catIOpenCount30Days / totalFindings30Days()) *
                100).toFixed(1) + '%' : '0.0%' }}
              </div>
            </div>
            <div
              class="w-full flex items-center pr-2 transition-all duration-300 ease-in-out cursor-default hover:translate-x-2 legend-item">
              <div class="shrink-0 mr-2 w-5 h-5 rounded transition-all duration-300 ease-in-out item-color"
                [style.backgroundColor]="'rgba(251, 167, 50, 0.8)'"></div>
              <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-semibold ml-2 flex-1 item-label">
                Medium</div>
              <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-medium min-w-[1.5rem] item-value">{{
                tenableMetrics().catIIOpenCount30Days }}</div>
              <div
                class="text-[var(--text-color)] opacity-70 text-[0.875rem] ml-2 w-14 text-left shrink-0 item-percent">
                {{ totalFindings30Days() > 0 ? ((tenableMetrics().catIIOpenCount30Days / totalFindings30Days()) *
                100).toFixed(1) + '%' : '0.0%' }}
              </div>
            </div>
            <div
              class="w-full flex items-center pr-2 transition-all duration-300 ease-in-out cursor-default hover:translate-x-2 legend-item">
              <div class="shrink-0 mr-2 w-5 h-5 rounded transition-all duration-300 ease-in-out item-color"
                [style.backgroundColor]="'rgba(230, 185, 44, 0.8)'"></div>
              <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-semibold ml-2 flex-1 item-label">Low
              </div>
              <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-medium min-w-[1.5rem] item-value">{{
                tenableMetrics().catIIIOpenCount30Days }}</div>
              <div
                class="text-[var(--text-color)] opacity-70 text-[0.875rem] ml-2 w-14 text-left shrink-0 item-percent">
                {{ totalFindings30Days() > 0 ? ((tenableMetrics().catIIIOpenCount30Days / totalFindings30Days()) *
                100).toFixed(1) + '%' : '0.0%' }}
              </div>
            </div>
          </div>
        </div>
      </div>
      }
    </div>
  </div>

  <p-divider layout="vertical" class="!p-8 !mt-4 !mb-4" />

  <div class="basis-1/2">
    <div class="h-full flex flex-col">
      <h3 class="chart-title">Open Findings by Severity</h3>

      @if (allFindingsChartData()) {
      <div class="flex items-center w-full flex-grow">
        <div class="flex-[0_0_55%] flex justify-center items-center">
          <p-chart type="doughnut" [data]="allFindingsChartData()" [options]="findingsChartOptions()"
            styleClass="findings-chart">
          </p-chart>
        </div>

        <div class="flex-[0_0_45%] flex flex-col justify-center ml-2">
          <div class="flex flex-col w-full gap-4">
            <div
              class="w-full flex items-center pr-2 transition-all duration-300 ease-in-out cursor-default hover:translate-x-2 legend-item">
              <div class="shrink-0 mr-2 w-5 h-5 rounded transition-all duration-300 ease-in-out item-color"
                [style.backgroundColor]="'rgba(236, 72, 99, 0.8)'"></div>
              <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-semibold ml-2 flex-1 item-label">
                Critical / High</div>
              <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-medium min-w-[1.5rem] item-value">{{
                tenableMetrics().catIOpenCount }}</div>
              <div
                class="text-[var(--text-color)] opacity-70 text-[0.875rem] ml-2 w-14 text-left shrink-0 item-percent">
                {{ totalFindings() > 0 ? ((tenableMetrics().catIOpenCount / totalFindings()) *
                100).toFixed(1) + '%' : '0.0%' }}
              </div>
            </div>
            <div
              class="w-full flex items-center pr-2 transition-all duration-300 ease-in-out cursor-default hover:translate-x-2 legend-item">
              <div class="shrink-0 mr-2 w-5 h-5 rounded transition-all duration-300 ease-in-out item-color"
                [style.backgroundColor]="'rgba(251, 167, 50, 0.8)'"></div>
              <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-semibold ml-2 flex-1 item-label">
                Medium</div>
              <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-medium min-w-[1.5rem] item-value">{{
                tenableMetrics().catIIOpenCount }}</div>
              <div
                class="text-[var(--text-color)] opacity-70 text-[0.875rem] ml-2 w-14 text-left shrink-0 item-percent">
                {{ totalFindings() > 0 ? ((tenableMetrics().catIIOpenCount / totalFindings()) *
                100).toFixed(1) + '%' : '0.0%' }}
              </div>
            </div>
            <div
              class="w-full flex items-center pr-2 transition-all duration-300 ease-in-out cursor-default hover:translate-x-2 legend-item">
              <div class="shrink-0 mr-2 w-5 h-5 rounded transition-all duration-300 ease-in-out item-color"
                [style.backgroundColor]="'rgba(230, 185, 44, 0.8)'"></div>
              <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-semibold ml-2 flex-1 item-label">Low
              </div>
              <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-medium min-w-[1.5rem] item-value">{{
                tenableMetrics().catIIIOpenCount }}</div>
              <div
                class="text-[var(--text-color)] opacity-70 text-[0.875rem] ml-2 w-14 text-left shrink-0 item-percent">
                {{ totalFindings() > 0 ? ((tenableMetrics().catIIIOpenCount / totalFindings()) *
                100).toFixed(1) + '%' : '0.0%' }}
              </div>
            </div>
          </div>
        </div>
      </div>
      }
    </div>
  </div>
</div>

<div class="flex flex-row gap-4 mt-4 flex-wrap lg:flex-nowrap">
  @for (metric of metricsDisplay(); track metric.label) {
  <p-card
    [class]="'basis-1/5 md:basis-1/3 lg:basis-1/5 metric-card transition-all duration-300 ease-in-out rounded-xl overflow-hidden relative hover:-translate-y-0.5 hover:shadow-lg ' + metric.category">
    <div class="flex flex-col items-center text-center" [pTooltip]="metric?.tooltip" tooltipPosition="top">
      @if (metric.isLoading) {
      <div class="h-10 flex items-center justify-center">
        <p-progress-spinner class="!w-10 !h-10" strokeWidth="3" animationDuration=".8s" />
      </div>
      } @else {
      <div class="min-h-[60px] flex items-center justify-center">
        <div class="text-[2.5rem] font-bold text-[var(--text-secondary-color)] flex items-center gap-2"
          [class.critical]="metric.severity === 'critical'" [class.high]="metric.severity === 'high'"
          [class.medium]="metric.severity === 'medium'" [class.low]="metric.severity === 'low'">
          {{ metric.value }}
        </div>
      </div>
      }
      @if (metric.origin) {
      <div class="mt-1 text-[0.85rem] text-[var(--text-secondary-color)] font-medium leading-snug">
        {{ metric.origin }}
      </div>
      }
      <div class="mt-1 text-[0.95rem] text-[var(--text-secondary-color)] font-medium leading-snug">
        {{ metric.label }}
      </div>
    </div>
  </p-card>
  }
</div>