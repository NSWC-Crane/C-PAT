<!--
!##########################################################################
! CRANE PLAN OF ACTION AND MILESTONE AUTOMATION TOOL (C-PAT) SOFTWARE
! Use is governed by the Open Source Academic Research License Agreement
! contained in the LICENSE.MD file, which is part of this software package.
! BY USING OR MODIFYING THIS SOFTWARE, YOU ARE AGREEING TO THE TERMS AND
! CONDITIONS OF THE LICENSE.
!##########################################################################
-->

<div class="flex justify-between items-center card !p-2">
  <div class="font-medium opacity-70 ml-2">{{ collectionName() }} - {{ now | date: 'MMM d, y, h:mm a' }}</div>
  <div class="flex items-center gap-3">
    <div class="flex items-center gap-2">
      <span class="text-xs text-gray-400">Findings:</span>
      <p-buttongroup>
        <p-button
          size="small"
          severity="secondary"
          label="7 Days"
          tooltipPosition="left"
          pTooltip="Vulnerability Last Observed within 7 days"
          [outlined]="lastObservedTimeRange() !== '7'"
          (onClick)="onLastObservedRangeChange('7')"
          [disabled]="isLoading()"
        />
        <p-button
          size="small"
          severity="secondary"
          label="30 Days"
          tooltipPosition="left"
          pTooltip="Vulnerability Last Observed within 30 days"
          [outlined]="lastObservedTimeRange() !== '30'"
          (onClick)="onLastObservedRangeChange('30')"
          [disabled]="isLoading()"
        />
        <p-button
          size="small"
          severity="secondary"
          label="90 Days"
          tooltipPosition="left"
          pTooltip="Vulnerability Last Observed within 90 days"
          [outlined]="lastObservedTimeRange() !== '90'"
          (onClick)="onLastObservedRangeChange('90')"
          [disabled]="isLoading()"
        />
        <p-button size="small" severity="secondary" label="All" tooltipPosition="left" pTooltip="All open findings" [outlined]="lastObservedTimeRange() !== 'all'" (onClick)="onLastObservedRangeChange('all')" [disabled]="isLoading()" />
      </p-buttongroup>
    </div>

    <div class="relative flex gap-1">
      <p-button icon="pi pi-refresh" [rounded]="true" [text]="true" severity="secondary" (onClick)="refreshMetrics()" [disabled]="isLoading()" pTooltip="Refresh metrics" tooltipPosition="left" />
      <p-button icon="pi pi-external-link" severity="secondary" [rounded]="true" [text]="true" pTooltip="Export metrics" tooltipPosition="left" (onClick)="exportMetrics()" [disabled]="isLoading()" />
    </div>
  </div>
</div>

<p-card class="mt-4 w-full">
  <div class="relative">
    <div class="relative flex items-center gap-2 mb-2">
      <span class="text-xs text-gray-400">Hosts:</span>
      <p-buttongroup>
        <p-button size="small" severity="secondary" label="7 Days" [outlined]="hostTimeRange() !== '7'" (onClick)="onHostTimeRangeChange('7')" [disabled]="isLoading()" />
        <p-button size="small" severity="secondary" label="30 Days" [outlined]="hostTimeRange() !== '30'" (onClick)="onHostTimeRangeChange('30')" [disabled]="isLoading()" />
        <p-button size="small" severity="secondary" label="90 Days" [outlined]="hostTimeRange() !== '90'" (onClick)="onHostTimeRangeChange('90')" [disabled]="isLoading()" />
        <p-button size="small" severity="secondary" label="All" [outlined]="hostTimeRange() !== 'all'" (onClick)="onHostTimeRangeChange('all')" [disabled]="isLoading()" />
      </p-buttongroup>
      <div class="absolute left-0 right-0 flex justify-center pointer-events-none">
        <span class="text-s font-medium text-gray-400"> Vulnerability Per Host (VPH) Score - {{ tenableMetrics().validOnlineAssets }} Valid Hosts </span>
      </div>
    </div>

    <div class="relative -mb-10 mr-4 ml-4" style="height: 60px">
      <div class="absolute w-full">
        <div class="absolute" [style.left.%]="tenableMetrics().vphScore < 2.5 ? 100 : tenableMetrics().vphScore > 3.5 ? 0 : 100 - (tenableMetrics().vphScore - 2.5) * 100" style="transform: translateX(-50%); z-index: 10">
          <div class="flex items-center gap-2 -mt-2 ml-2 mr-2">
            <div class="px-3 py-2 rounded-lg font-bold text-center" [style.background-color]="getVPHColor(tenableMetrics().vphScore)" style="opacity: 0.9; color: white" [pTooltip]="vphTooltip" tooltipStyleClass="wide-tooltip" appendTo="body">
              {{ isLoading() ? '-' : tenableMetrics().vphScore.toFixed(2) }}
            </div>
            <ng-template #vphTooltip>
              <div class="flex flex-col gap-3 text-sm">
                <div><span class="font-semibold">Vulnerabilities Per Host (VPH)</span></div>
                <div class="font-semibold">Formula:</div>
                <code class="inline-block self-start bg-black/30 px-2 py-1 rounded text-xs">(((C + H) / Hosts × 10) + (M / Hosts × 4) + (L / Hosts × 1)) ÷ 15</code>
                <div>
                  where:<br />
                  <code class="text-xs">C</code> = Critical Vulnerabilities<br />
                  <code class="text-xs">H</code> = High Vulnerabilities<br />
                  <code class="text-xs">M</code> = Medium Vulnerabilities<br />
                  <code class="text-xs">L</code> = Low Vulnerabilities<br />
                  <code class="text-xs">Hosts</code> = Valid Online Assets
                </div>
                <div class="border-t border-gray-600 pt-3">
                  <span class="font-semibold">Current Parameters:</span>
                  <ul class="ml-4 mt-1 list-disc">
                    <li>
                      Valid Hosts: <span class="font-semibold">{{ tenableMetrics().validOnlineAssets }}</span>
                    </li>
                    <li>
                      Host Time Range: <span class="font-semibold">{{ hostTimeRange() === 'all' ? 'All Time' : 'Last ' + hostTimeRange() + ' Days' }}</span>
                    </li>
                    <li>
                      Findings Time Range: <span class="font-semibold">{{ lastObservedTimeRange() === 'all' ? 'All Time' : 'Last ' + lastObservedTimeRange() + ' Days' }}</span>
                    </li>
                  </ul>
                </div>
                <div class="border-t border-gray-600 pt-3">
                  <span class="font-semibold">Risk Rating:</span>
                  <ul class="ml-4 mt-1 list-disc space-y-1">
                    <li>
                      <span class="inline-flex items-center justify-center w-20 font-semibold px-1 rounded" style="background-color: rgba(235, 70, 100, 0.75); color: rgba(255, 255, 255, 0.9)">High</span> <span class="font-semibold ml-1">≥ 3.5</span>
                    </li>
                    <li>
                      <span class="inline-flex items-center justify-center w-20 font-semibold px-1 rounded" style="background-color: rgba(250, 165, 50, 0.75); color: rgba(255, 255, 255, 0.9)">Medium</span>
                      <span class="font-semibold ml-1">≥ 2.5 and &lt; 3.5</span>
                    </li>
                    <li>
                      <span class="inline-flex items-center justify-center w-20 font-semibold px-1 rounded" style="background-color: rgba(15, 185, 130, 0.75); color: rgba(255, 255, 255, 0.9)">Low</span>
                      <span class="font-semibold ml-1">&lt; 2.5</span>
                    </li>
                  </ul>
                </div>
              </div>
            </ng-template>
          </div>
          <div class="absolute left-1/2 transform -translate-x-1/2" style="width: 2px; background-color: white; border-radius: 1px; height: 42px; top: 39px">
            <div class="absolute w-2 h-2 bg-white rounded-full" style="top: -2px; left: -2.3px"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="relative">
      <div class="flex justify-between mb-2">
        <span class="text-red-400 font-semibold text-xs opacity-90">High Risk</span>
        <span class="text-[#10b981] font-semibold text-xs text-right">Low Risk</span>
      </div>

      <div class="relative rounded-full h-10 overflow-hidden shadow-lg" style="background: linear-gradient(to right, rgba(235, 70, 100, 0.8) 0%, rgba(250, 145, 60, 0.8) 33%, rgba(250, 190, 35, 0.8) 66%, rgba(15, 185, 130, 0.8) 100%)"></div>
    </div>
  </div>

  <div class="mt-5 pt-3 border-t border-gray-700">
    <div class="flex justify-between gap-2 mt-2">
      <div class="flex items-center gap-1">
        <div class="w-8 h-3 rounded-full" style="background-color: rgba(235, 70, 100, 0.8)"></div>
        <span class="text-xs text-gray-300">High (> 3.5)</span>
      </div>
      <div class="flex items-center gap-1">
        <div class="w-8 h-3 rounded-full" style="background-color: rgba(250, 190, 36, 0.8)"></div>
        <span class="text-xs text-gray-300">Moderate (~ 3.0)</span>
      </div>
      <div class="flex items-center gap-1">
        <div class="w-8 h-3 rounded-full" style="background-color: rgba(15, 185, 130, 0.8)"></div>
        <span class="text-xs text-gray-300">Low (< 2.5)</span>
      </div>
    </div>
  </div>
</p-card>

<div class="flex flex-row mt-4 gap-4">
  <div class="basis-1/3">
    <p-card class="cat-compliance-card">
      <div class="dark-web-style-metric">
        <div class="metric-circle-container">
          <div class="metric-circle">
            <span class="metric-circle-value">
              {{ isLoading() ? '-' : tenableMetrics().catICompliance.toFixed(0) }}
            </span>
            <span class="metric-percent">%</span>
          </div>
          <div class="metric-line"></div>
        </div>
        <div
          class="metric-text-container"
          [pTooltip]="'Percentage of Critical and High severity findings that were published 30+ days ago' + (getLastObservedText() ? ', last observed ' + getLastObservedText() : '') + ', and have an existing POAM in an Approved status.'"
          tooltipPosition="top"
        >
          <div class="metric-origin">Tenable</div>
          <div class="metric-description pr-[7.5px]">CAT-I POAM Compliance %</div>
        </div>
      </div>
    </p-card>
  </div>

  <div class="basis-1/3">
    <p-card class="cat-compliance-card">
      <div class="dark-web-style-metric">
        <div class="metric-circle-container">
          <div class="metric-circle">
            <span class="metric-circle-value">
              {{ isLoading() ? '-' : tenableMetrics().catIICompliance.toFixed(0) }}
            </span>
            <span class="metric-percent">%</span>
          </div>
          <div class="metric-line"></div>
        </div>
        <div
          class="metric-text-container"
          [pTooltip]="'Percentage of Medium severity findings that were published 30+ days ago' + (getLastObservedText() ? ', last observed ' + getLastObservedText() : '') + ', and have an existing POAM in an Approved status.'"
          tooltipPosition="top"
        >
          <div class="metric-origin">Tenable</div>
          <div class="metric-description pr-[3.75px]">CAT-II POAM Compliance %</div>
        </div>
      </div>
    </p-card>
  </div>

  <div class="basis-1/3">
    <p-card class="cat-compliance-card">
      <div class="dark-web-style-metric">
        <div class="metric-circle-container">
          <div class="metric-circle">
            <span class="metric-circle-value">
              {{ isLoading() ? '-' : tenableMetrics().catIIICompliance.toFixed(0) }}
            </span>
            <span class="metric-percent">%</span>
          </div>
          <div class="metric-line"></div>
        </div>
        <div
          class="metric-text-container"
          [pTooltip]="'Percentage of Low severity findings that were published 30+ days ago' + (getLastObservedText() ? ', last observed ' + getLastObservedText() : '') + ', and have an existing POAM in an Approved status.'"
          tooltipPosition="top"
        >
          <div class="metric-origin">Tenable</div>
          <div class="metric-description">CAT-III POAM Compliance %</div>
        </div>
      </div>
    </p-card>
  </div>
</div>

<div class="card flex flex-row mt-4">
  <div class="basis-1/2">
    <div class="h-full flex flex-col">
      <h3 class="chart-title">Open Findings by Severity {{ lastObservedTimeRange() === 'all' ? '' : '(' + lastObservedTimeRange() + '+ Days)' }}</h3>

      @if (findingsChartData()) {
        <div class="flex items-center w-full flex-grow">
          <div class="flex-[0_0_55%] flex justify-center items-center">
            <p-chart type="doughnut" [data]="findingsChartData()" [options]="findingsChartOptions()" styleClass="findings-chart"> </p-chart>
          </div>

          <div class="flex-[0_0_45%] flex flex-col justify-center ml-2">
            <div class="flex flex-col w-full gap-4">
              <div class="w-full flex items-center pr-2 transition-all duration-300 ease-in-out cursor-default hover:translate-x-2 legend-item">
                <div class="shrink-0 mr-2 w-5 h-5 rounded transition-all duration-300 ease-in-out item-color" [style.backgroundColor]="'rgba(235, 70, 100, 0.8)'"></div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-semibold ml-2 flex-1 item-label">Critical / High</div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-medium min-w-[1.5rem] item-value">{{ tenableMetrics().catIOpenCount30Days }}</div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] ml-2 w-14 text-left shrink-0 item-percent">
                  {{ totalFindings30Days() > 0 ? ((tenableMetrics().catIOpenCount30Days / totalFindings30Days()) * 100).toFixed(1) + '%' : '0.0%' }}
                </div>
              </div>
              <div class="w-full flex items-center pr-2 transition-all duration-300 ease-in-out cursor-default hover:translate-x-2 legend-item">
                <div class="shrink-0 mr-2 w-5 h-5 rounded transition-all duration-300 ease-in-out item-color" [style.backgroundColor]="'rgba(250, 165, 50, 0.8)'"></div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-semibold ml-2 flex-1 item-label">Medium</div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-medium min-w-[1.5rem] item-value">{{ tenableMetrics().catIIOpenCount30Days }}</div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] ml-2 w-14 text-left shrink-0 item-percent">
                  {{ totalFindings30Days() > 0 ? ((tenableMetrics().catIIOpenCount30Days / totalFindings30Days()) * 100).toFixed(1) + '%' : '0.0%' }}
                </div>
              </div>
              <div class="w-full flex items-center pr-2 transition-all duration-300 ease-in-out cursor-default hover:translate-x-2 legend-item">
                <div class="shrink-0 mr-2 w-5 h-5 rounded transition-all duration-300 ease-in-out item-color" [style.backgroundColor]="'rgba(230, 185, 45, 0.8)'"></div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-semibold ml-2 flex-1 item-label">Low</div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-medium min-w-[1.5rem] item-value">{{ tenableMetrics().catIIIOpenCount30Days }}</div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] ml-2 w-14 text-left shrink-0 item-percent">
                  {{ totalFindings30Days() > 0 ? ((tenableMetrics().catIIIOpenCount30Days / totalFindings30Days()) * 100).toFixed(1) + '%' : '0.0%' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  </div>

  <p-divider layout="vertical" class="!p-8 !mt-4 !mb-4" />

  <div class="basis-1/2">
    <div class="h-full flex flex-col">
      <h3 class="chart-title">Open Findings by Severity (All)</h3>

      @if (allFindingsChartData()) {
        <div class="flex items-center w-full flex-grow">
          <div class="flex-[0_0_55%] flex justify-center items-center">
            <p-chart type="doughnut" [data]="allFindingsChartData()" [options]="findingsChartOptions()" styleClass="findings-chart"> </p-chart>
          </div>

          <div class="flex-[0_0_45%] flex flex-col justify-center ml-2">
            <div class="flex flex-col w-full gap-4">
              <div class="w-full flex items-center pr-2 transition-all duration-300 ease-in-out cursor-default hover:translate-x-2 legend-item">
                <div class="shrink-0 mr-2 w-5 h-5 rounded transition-all duration-300 ease-in-out item-color" [style.backgroundColor]="'rgba(235, 70, 100, 0.8)'"></div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-semibold ml-2 flex-1 item-label">Critical / High</div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-medium min-w-[1.5rem] item-value">{{ tenableMetrics().catIOpenCount }}</div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] ml-2 w-14 text-left shrink-0 item-percent">
                  {{ totalFindings() > 0 ? ((tenableMetrics().catIOpenCount / totalFindings()) * 100).toFixed(1) + '%' : '0.0%' }}
                </div>
              </div>
              <div class="w-full flex items-center pr-2 transition-all duration-300 ease-in-out cursor-default hover:translate-x-2 legend-item">
                <div class="shrink-0 mr-2 w-5 h-5 rounded transition-all duration-300 ease-in-out item-color" [style.backgroundColor]="'rgba(250, 165, 50, 0.8)'"></div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-semibold ml-2 flex-1 item-label">Medium</div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-medium min-w-[1.5rem] item-value">{{ tenableMetrics().catIIOpenCount }}</div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] ml-2 w-14 text-left shrink-0 item-percent">
                  {{ totalFindings() > 0 ? ((tenableMetrics().catIIOpenCount / totalFindings()) * 100).toFixed(1) + '%' : '0.0%' }}
                </div>
              </div>
              <div class="w-full flex items-center pr-2 transition-all duration-300 ease-in-out cursor-default hover:translate-x-2 legend-item">
                <div class="shrink-0 mr-2 w-5 h-5 rounded transition-all duration-300 ease-in-out item-color" [style.backgroundColor]="'rgba(230, 185, 45, 0.8)'"></div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-semibold ml-2 flex-1 item-label">Low</div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] font-medium min-w-[1.5rem] item-value">{{ tenableMetrics().catIIIOpenCount }}</div>
                <div class="text-[var(--text-color)] opacity-70 text-[0.875rem] ml-2 w-14 text-left shrink-0 item-percent">
                  {{ totalFindings() > 0 ? ((tenableMetrics().catIIIOpenCount / totalFindings()) * 100).toFixed(1) + '%' : '0.0%' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
</div>

<div class="flex flex-row gap-4 mt-4 flex-wrap lg:flex-nowrap">
  @for (metric of metricsDisplay(); track metric.label) {
    <p-card [class]="'basis-1/2 md:basis-1/3 lg:basis-1/6 metric-card transition-all duration-300 ease-in-out rounded-xl overflow-hidden relative hover:-translate-y-0.5 hover:shadow-lg ' + metric.category">
      <div class="flex flex-col items-center text-center" [pTooltip]="metric?.tooltip" tooltipPosition="top">
        @if (metric.isLoading) {
          <div class="h-10 flex items-center justify-center">
            <p-progress-spinner class="!w-10 !h-10" strokeWidth="3" animationDuration=".8s" />
          </div>
        } @else {
          <div class="min-h-[60px] flex items-center justify-center">
            <div
              class="text-[2.5rem] font-bold text-[var(--text-secondary-color)] flex items-center gap-2"
              [class.critical]="metric.severity === 'critical'"
              [class.high]="metric.severity === 'high'"
              [class.medium]="metric.severity === 'medium'"
              [class.low]="metric.severity === 'low'"
            >
              {{ metric.value }}
            </div>
          </div>
        }
        @if (metric.origin) {
          <div class="mt-1 text-[0.85rem] text-[var(--text-secondary-color)] font-medium leading-snug">
            {{ metric.origin }}
          </div>
        }
        <div class="mt-1 text-[0.95rem] text-[var(--text-secondary-color)] font-medium leading-snug">
          {{ metric.label }}
        </div>
      </div>
    </p-card>
  }
</div>

<div class="card mt-4">
  <h3 class="chart-title !mb-4">High-Risk Assets</h3>
  <cpat-tenable-high-risk-assets-table [tenableRepoId]="this.collection.originCollectionId" />
</div>
